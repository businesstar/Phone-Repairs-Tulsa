<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Repairs Tulsa | Tulsa, OK</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic components -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug for development/error checking
        setLogLevel('debug');

        // --- GLOBAL FIREBASE & APP VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app, db, auth;
        let currentUserId = 'unknown';

        // --- UTILITY FUNCTIONS ---

        // Function to handle exponential backoff for API calls
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit, retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                }
            }
        }

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing or empty. Cannot initialize Firestore.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using the provided custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                currentUserId = auth.currentUser?.uid || 'anonymous';
                document.getElementById('user-id-display').textContent = `User ID: ${currentUserId}`;

                startChatListener();

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                document.getElementById('chat-messages').innerHTML = `<p class="text-red-500 p-4 text-sm">Error initializing chat: ${error.message}. Check console for details.</p>`;
            }
        }

        // --- CHAT FUNCTIONS (Feature 1: Conversational Assistant) ---

        // Gemini API configuration
        const API_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;
        // Updated identity to Phone Repairs Tulsa
        const SYSTEM_INSTRUCTION = "You are a friendly and knowledgeable customer service agent for 'Phone Repairs Tulsa' in Tulsa, OK. Your primary focus is quick, affordable repairs for devices like iPhones and Samsung Galaxy phones. Always state that all common iPhone repairs (screen, battery) cost between $60 and $100. Always keep answers concise and professional. Do not accept appointments; tell the user to visit our shop or call us at (918) 376-0093. Mention our location is Tulsa, OK.";

        async function getGeminiResponse(message) {
            const payload = {
                contents: [{ parts: [{ text: message }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(API_URL, options);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    console.error("Gemini response lacked text content:", result);
                    return "Sorry, I'm having trouble connecting right now. Please try again or call us at (918) 376-0093!";
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "Our digital assistant is currently unavailable. Please call our store at (918) 376-0093.";
            }
        }

        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/chat_messages`;

        async function sendMessage(text) {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const chatMessagesDiv = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');

            chatInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...`;

            try {
                await addDoc(collection(db, CHAT_COLLECTION_PATH), {
                    userId: currentUserId,
                    text: text,
                    timestamp: serverTimestamp(),
                    role: 'user',
                    appId: appId
                });

                const geminiText = await getGeminiResponse(text);

                await addDoc(collection(db, CHAT_COLLECTION_PATH), {
                    userId: 'TulsaPhoneRepairs-Bot',
                    text: geminiText,
                    timestamp: serverTimestamp(),
                    role: 'bot',
                    appId: appId
                });

                chatInput.value = ''; 

            } catch (e) {
                console.error("Error sending message: ", e);
                chatMessagesDiv.innerHTML += `<div class="p-2 text-sm text-red-500 text-center">Failed to send message.</div>`;
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = `Send`;
                chatInput.focus();
            }
        }

        function startChatListener() {
            if (!db) return;

            const chatMessagesDiv = document.getElementById('chat-messages');
            const q = query(collection(db, CHAT_COLLECTION_PATH), orderBy('timestamp', 'asc'));

            onSnapshot(q, (snapshot) => {
                let messagesHtml = '';
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const isBot = data.role === 'bot';
                    const isCurrentUser = data.userId === currentUserId && data.role === 'user';
                    
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
                    
                    let senderName = isBot ? 'PRT Bot' : (isCurrentUser ? 'You' : 'User');

                    const messageClass = isBot
                        ? 'bg-blue-100 text-gray-800 self-start rounded-b-xl rounded-tr-xl'
                        : (isCurrentUser
                            ? 'bg-red-500 text-white self-end rounded-b-xl rounded-tl-xl'
                            : 'bg-gray-200 text-gray-800 self-start rounded-b-xl rounded-tr-xl');
                    
                    const nameColor = isBot ? 'text-blue-600' : 'text-xs text-gray-400';

                    messagesHtml += `
                        <div class="flex flex-col mb-4 ${isCurrentUser ? 'items-end' : 'items-start'}">
                            <div class="px-3 py-1 ${nameColor} font-semibold">${senderName}</div>
                            <div class="${messageClass} p-3 max-w-xs md:max-w-md shadow-md break-words">
                                ${data.text.replace(/\n/g, '<br>')}
                                <span class="block mt-1 text-xs opacity-70 ${isCurrentUser ? 'text-white' : 'text-gray-500'}">${time}</span>
                            </div>
                        </div>
                    `;
                });
                chatMessagesDiv.innerHTML = messagesHtml;
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }, (error) => {
                console.error("Error listening to chat messages:", error);
            });
        }
        
        // --- QUOTE FUNCTIONS (Feature 2: Structured Quote Estimator) ---
        const QUOTE_SYSTEM_INSTRUCTION = "You are an AI estimator for 'Phone Repairs Tulsa' in Tulsa, OK. Based on the user's phone model and damage type, provide a specific repair estimate. ALL screen and battery repairs for iPhones MUST be quoted between $60 and $100. Repair time should be a realistic range (e.g., 45-90 minutes).";

        function displayAlert(message) {
            const alertBox = document.getElementById('custom-alert');
            alertBox.textContent = message;
            alertBox.classList.remove('hidden');
            setTimeout(() => { alertBox.classList.add('hidden'); }, 3000);
        }

        async function getRepairQuote(model, damage) {
            const quoteResultDiv = document.getElementById('quote-result');
            const quoteButton = document.getElementById('quote-button');
            
            if (!model || !damage) {
                displayAlert("Please enter both the phone model and damage type to get a quote.");
                return;
            }

            quoteButton.disabled = true;
            quoteButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating Quote...`;
            quoteResultDiv.innerHTML = `<p class="text-center text-sm text-gray-500 p-4">Calculating the best estimate...</p>`;

            const userQuery = `Provide a repair quote for a ${model} with ${damage}.`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: QUOTE_SYSTEM_INSTRUCTION }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            estimatedPrice: { type: "STRING" },
                            estimatedTime: { type: "STRING" },
                            disclaimer: { type: "STRING" }
                        },
                        required: ["estimatedPrice", "estimatedTime", "disclaimer"]
                    }
                }
            };

            try {
                const response = await fetchWithBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const quote = JSON.parse(result.candidates[0].content.parts[0].text);

                quoteResultDiv.innerHTML = `
                    <h5 class="text-xl font-bold text-gray-800 mb-3 flex items-center justify-center"><i data-lucide="calculator" class="w-6 h-6 mr-2 text-red-500"></i> Your Instant Quote</h5>
                    <div class="space-y-3">
                        <p class="text-2xl font-extrabold text-tulsa-red border-b pb-2">Price Estimate: ${quote.estimatedPrice}</p>
                        <p class="text-lg font-medium text-gray-700">Repair Time: <span class="text-green-600 font-semibold">${quote.estimatedTime}</span></p>
                        <p class="text-sm text-gray-500 italic pt-2 border-t mt-3">${quote.disclaimer}</p>
                    </div>
                `;
                lucide.createIcons();
            } catch (error) {
                quoteResultDiv.innerHTML = `<p class="text-center text-red-500 text-sm p-4">Error generating quote. Call (918) 376-0093.</p>`;
            } finally {
                quoteButton.disabled = false;
                quoteButton.innerHTML = `✨ Generate Quote`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            const chatForm = document.getElementById('chat-form');
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = document.getElementById('chat-input').value.trim();
                if (text) sendMessage(text);
            });
            document.getElementById('quote-button').addEventListener('click', () => {
                getRepairQuote(document.getElementById('phone-model-input').value, document.getElementById('damage-type-input').value);
            });
        });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .section-padding { padding: 4rem 1rem; }
        .text-tulsa-red { color: #D61A3C; }
        .bg-tulsa-gray { background-color: #3C4043; }
        .btn-primary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.5);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.5);
        }
        #custom-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
    </style>
</head>
<body class="text-gray-800">

    <div id="custom-alert" class="hidden bg-yellow-400 text-yellow-900 p-3 rounded-lg shadow-xl text-sm font-semibold transition duration-300"></div>

    <!-- Header -->
    <header class="bg-white shadow-lg sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2">
                <i data-lucide="wrench" class="w-8 h-8 text-tulsa-red"></i>
                <h1 class="text-2xl font-extrabold tracking-tight text-tulsa-gray">Phone Repairs Tulsa</h1>
            </a>
            <p class="hidden sm:block text-sm font-medium text-gray-500">Tulsa, OK's Local Experts | (918) 376-0093</p>
        </div>
    </header>

    <!-- Hero -->
    <section class="bg-tulsa-gray text-white section-padding">
        <div class="max-w-7xl mx-auto text-center">
            <div class="space-y-4">
                <h2 class="text-5xl md:text-6xl font-extrabold tracking-tight leading-tight uppercase">
                    Tulsa's Trusted Phone Repair
                </h2>
                <p class="text-xl md:text-2xl font-light text-gray-300 max-w-3xl mx-auto">
                    Professional, same-day repairs in Tulsa, Oklahoma. Quality service you can count on.
                </p>
                <a href="#services" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-full text-white bg-red-600 hover:bg-red-700 md:py-4 md:text-lg md:px-10 btn-primary">
                    View Services <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- Services -->
    <section id="services" class="bg-white section-padding">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <span class="text-tulsa-red text-lg font-semibold uppercase">Expert Solutions</span>
                <h3 class="mt-2 text-4xl font-bold text-gray-900">iPhone, Samsung & Pixel Repairs</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-gray-50 p-6 rounded-xl shadow border-t-4 border-red-500">
                    <i data-lucide="screen-share" class="w-10 h-10 text-tulsa-red mb-4"></i>
                    <h4 class="text-2xl font-bold mb-2">Screen Replacement</h4>
                    <p class="text-gray-600">Premium quality displays for all iPhone and Android models. Fixed fast while you wait.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-xl shadow border-t-4 border-red-500">
                    <i data-lucide="battery-charging" class="w-10 h-10 text-tulsa-red mb-4"></i>
                    <h4 class="text-2xl font-bold mb-2">Battery Refresh</h4>
                    <p class="text-gray-600">Get your battery life back to 100%. We use certified replacement parts for safety and longevity.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-xl shadow border-t-4 border-red-500">
                    <i data-lucide="droplets" class="w-10 h-10 text-tulsa-red mb-4"></i>
                    <h4 class="text-2xl font-bold mb-2">Water Damage</h4>
                    <p class="text-gray-600">Advanced diagnostic tools to recover devices from liquid damage. High success rates!</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing -->
    <section id="pricing" class="bg-gray-100 section-padding">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h3 class="text-4xl font-bold text-gray-900 mb-4">Flat-Rate iPhone Pricing</h3>
            <p class="text-xl text-gray-600 mb-8">Most standard iPhone repairs fall within this affordable range.</p>

            <div class="bg-white p-8 rounded-2xl shadow-2xl border-b-8 border-red-500">
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-8">
                    <div class="text-center">
                        <p class="text-5xl font-extrabold text-tulsa-red">$60 - $100</p>
                        <p class="text-gray-500 mt-2 font-medium italic">Covers Screen & Battery for all iPhone models</p>
                    </div>
                </div>
            </div>

            <!-- AI Quote Estimator -->
            <div id="quote-estimator" class="mt-12 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h4 class="text-2xl font-bold text-gray-900 mb-6 flex items-center justify-center">
                    <i data-lucide="sparkles" class="w-6 h-6 text-yellow-500 mr-2"></i> AI Quick Quote
                </h4>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <input type="text" id="phone-model-input" placeholder="Device (e.g. iPhone 13)" class="p-3 border rounded-lg focus:ring-red-500">
                    <input type="text" id="damage-type-input" placeholder="Issue (e.g. Screen)" class="p-3 border rounded-lg focus:ring-red-500">
                    <button id="quote-button" class="bg-red-600 text-white px-5 py-3 rounded-lg font-semibold hover:bg-red-700">✨ Get Quote</button>
                </div>
                <div id="quote-result" class="mt-6 p-4 bg-gray-50 rounded-lg border flex items-center justify-center min-h-[100px]">
                    <p class="text-gray-500">Instant estimates for any model or damage.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact & Chat -->
    <section id="contact" class="bg-white section-padding">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-2 gap-12">
            <div class="space-y-8">
                <h3 class="text-4xl font-bold text-gray-900">Visit Us in Tulsa</h3>
                <div class="space-y-6">
                    <div class="flex items-start space-x-4">
                        <i data-lucide="map-pin" class="w-6 h-6 text-tulsa-red mt-1"></i>
                        <div>
                            <p class="font-bold text-xl">Area Location</p>
                            <p class="text-gray-700">Tulsa, OK 74103</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <i data-lucide="phone-call" class="w-6 h-6 text-tulsa-red mt-1"></i>
                        <div>
                            <p class="font-bold text-xl">Phone Number</p>
                            <p class="text-gray-700 text-2xl font-semibold">(918) 376-0093</p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <i data-lucide="clock" class="w-6 h-6 text-tulsa-red mt-1"></i>
                        <div>
                            <p class="font-bold text-xl">Hours of Operation</p>
                            <p class="text-gray-700">Mon - Sun: 7:00 AM - 9:00 PM</p>
                        </div>
                    </div>
                </div>
                <p id="user-id-display" class="text-xs text-gray-400"></p>
            </div>

            <!-- Chat Container -->
            <div class="bg-gray-100 p-6 rounded-xl shadow-2xl flex flex-col h-[500px]" id="chat-container">
                <h4 class="text-xl font-bold mb-4 flex items-center">
                    <i data-lucide="message-circle" class="w-6 h-6 text-tulsa-red mr-2"></i> Support Chat
                </h4>
                <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 p-4 mb-4 bg-white rounded-lg border">
                    <div class="flex flex-col items-start">
                        <div class="px-3 py-1 text-blue-600 font-semibold text-xs uppercase">PRT Bot</div>
                        <div class="bg-blue-100 text-gray-800 rounded-b-xl rounded-tr-xl p-3 shadow-sm text-sm">
                            Welcome to Phone Repairs Tulsa! Need a price or a quick fix? Ask me anything.
                        </div>
                    </div>
                </div>
                <form id="chat-form" class="flex space-x-2">
                    <input type="text" id="chat-input" placeholder="Type your question..." class="flex-grow p-3 border rounded-lg focus:ring-red-500" required>
                    <button type="submit" id="send-button" class="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700">Send</button>
                </form>
            </div>
        </div>
    </section>

    <footer class="bg-tulsa-gray text-white py-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <div class="mb-6 flex justify-center items-center space-x-2">
                <i data-lucide="wrench" class="w-6 h-6 text-red-500"></i>
                <span class="text-2xl font-bold uppercase tracking-widest">Phone Repairs Tulsa</span>
            </div>
            <p class="text-gray-400">&copy; 2024 Phone Repairs Tulsa. All Rights Reserved.</p>
            <p class="text-gray-500 mt-2">Serving the Tulsa, OK metro area with pride.</p>
        </div>
    </footer>

    <script> lucide.createIcons(); </script>
</body>
</html>
